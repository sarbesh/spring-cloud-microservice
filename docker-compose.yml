version: "3.9"
services:
  config-server:
    container_name: config-server
    image: openjdk:8-jdk
#    build:
#      context: ./ConfigServer
#      dockerfile: Dockerfile
    ports:
      - "8888:8888"
    expose:
      - 8888
    working_dir: "/app"
    volumes:
      - "./ConfigServer/target:/app"
      - "./../ConfigRepo:/config_files"
      - "${HOME}/.m2:/root/.m2"
    environment:
      - CONFIG_REPO_URL=/config_files # https://github.com/sarbesh/ConfigRepo.git
      - EUREKA_URL=http://user:password@eureka-server:8761
      - CONFIG_SERVER_PASSWORD=password
      - ENCRYPT_KEY=password
      - HOST_NAME=config-server
      - PORT=8888
      - CONFIG_SERVER_URL=http://user:password@config-server:8888
      - EUREKA_USER_PASSWORD=password
      - SPRING_PROFILES_ACTIVE=local
      - EUREKA_REGISTER=true
      - EUREKA_FETCH=true
    #    command: ["mvn", "spring-boot:run"]
    command: ["java", "-jar", "configserver-0.0.1-SNAPSHOT.jar"]
    healthcheck:
      #      test: ["CMD", "curl", "--fail", "http://user:password@localhost:8888/actuator/health", "||", "exit", "1"]
      test: curl -f -u user:password http://localhost:8888/actuator/health || exit 1
      interval: 30s
      timeout: 30s
      retries: 5
      start_period: 30s
    deploy:
      replicas: 1
#      resources:
#        limits:
#          cpus: "0.2"
#          memory: "512MB"
  eureka-server:
    container_name: eureka-server
    image: openjdk:8-jdk
    ports:
      - "8761:8761"
    expose:
      - 8761
    working_dir: "/app"
    volumes:
      - "./EurekaServer/target:/app"
    environment:
      - CONFIG_SERVER_URL=http://user:password@config-server:8888
      - HOST_NAME=eureka-server
      - EUREKA_USER_PASSWORD=password
      - PORT=8761
      - SPRING_PROFILES_ACTIVE=local
      - EUREKA_REGISTER=true
      - EUREKA_FETCH=true
    command: ["java", "-jar", "eurekaserver-0.0.1-SNAPSHOT.jar"]
    depends_on:
      config-server:
        condition: service_healthy
    healthcheck:
      test: curl -f http://user:password@eureka-server:8761/actuator/health || exit 1
      interval: 30s
      timeout: 30s
      retries: 5
      start_period: 60s
    deploy:
      replicas: 1
#      resources:
#        limits:
#          cpus: "0.2"
#          memory: "512MB"
  api-gateway:
    container_name: api-gateway
    image: openjdk:8-jdk
    ports:
      - "8080:8080"
    working_dir: "/app"
    volumes:
      - "./GatewayService/target:/app"
    environment:
      - CONFIG_SERVER_URL=http://user:password@config-server:8888
      - EUREKA_URL=http://user:password@eureka-server:8761
      - HOST_NAME=api-gateway
      - EUREKA_USER_PASSWORD=password
      - PORT=8080
      - SPRING_PROFILES_ACTIVE=local
      - EUREKA_REGISTER=true
      - EUREKA_FETCH=true
    command: ["java", "-jar", "GatewayService-0.0.1-SNAPSHOT.jar"]
    depends_on:
      config-server:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    healthcheck:
      test: curl -f http://user:password@api-gateway:8080/actuator/health || exit 1
      interval: 30s
      timeout: 30s
      retries: 5
      start_period: 60s
    deploy:
      replicas: 1
#      resources:
#        limits:
#          cpus: "0.2"
#          memory: "512MB"
